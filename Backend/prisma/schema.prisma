generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  password         String
  name             String
  phone            String?        @db.VarChar(10)
  role             Role           @default(CUSTOMER)
  avatar           String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  addresses        Address[]
  favorites        Favorite[]
  notifications    Notification[]
  orders           Order[]
  payments         Payment[]
  reviews          Review[]
  shop             Shop?

  @@index([email])
  @@index([role])
  @@map("users")
}

model Shop {
  id           String     @id @default(cuid())
  name         String
  description  String?
  slug         String?    @unique
  category     String
  image        String?
  logo         String?
  status       ShopStatus @default(open)
  rating       Float      @default(0)
  totalRatings Int        @default(0)
  pincode      String     @db.VarChar(6)
  address      String
  city         String
  state        String?
  openingTime  String     @default("09:00")
  closingTime  String     @default("22:00")
  shopkeeperId String     @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  categories   Category[]
  favorites    Favorite[]
  menuItems    MenuItem[]
  orders       Order[]
  reviews      Review[]
  shopkeeper   User       @relation(fields: [shopkeeperId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([shopkeeperId])
  @@map("shops")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  description String?
  image       String?
  order       Int        @default(0)
  shopId      String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  shop        Shop       @relation(fields: [shopId], references: [id], onDelete: Cascade)
  menuItems   MenuItem[]

  @@unique([shopId, name])
  @@map("categories")
}

model MenuItem {
  id          String      @id @default(cuid())
  name        String
  description String?
  price       Float
  image       String?
  available   Boolean     @default(true)
  popular     Boolean     @default(false)
  shopId      String
  categoryId  String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  shop        Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  orderItems  OrderItem[]

  @@map("menu_items")
}

model Order {
  id              String        @id @default(cuid())
  token           String
  orderNumber     String        @unique
  customerId      String
  shopId          String
  status          OrderStatus   @default(pending)
  orderType       OrderType     @default(NOW)
  scheduledTime   DateTime?
  subtotal        Float
  discount        Float         @default(0)
  total           Float
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus @default(pending)
  addressId       String?
  placedAt        DateTime      @default(now())
  confirmedAt     DateTime?
  preparingAt     DateTime?
  preparationTime Int?
  readyAt         DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  items           OrderItem[]
  address         Address?      @relation(fields: [addressId], references: [id])
  customer        User          @relation(fields: [customerId], references: [id])
  shop            Shop          @relation(fields: [shopId], references: [id])
  payment         Payment?

  @@unique([shopId, token])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  menuItemId String
  quantity   Int
  price      Float
  subtotal   Float
  notes      String?
  createdAt  DateTime @default(now())
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String        @unique
  customerId      String
  amount          Float
  method          PaymentMethod
  status          PaymentStatus @default(pending)
  transactionId   String?
  paymentIntentId String?
  receiptUrl      String?
  paidAt          DateTime?
  refundedAt      DateTime?
  refundAmount    Float?        @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  customer        User          @relation(fields: [customerId], references: [id])
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  label       String
  fullAddress String
  street      String
  city        String
  state       String?
  country     String   @default("USA")
  zipCode     String?
  latitude    Float?
  longitude   Float?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders      Order[]

  @@map("addresses")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  shopId    String
  createdAt DateTime @default(now())
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, shopId])
  @@map("favorites")
}

model Review {
  id        String       @id @default(cuid())
  userId    String
  shopId    String
  orderId   String?
  rating    Int
  comment   String?
  status    ReviewStatus @default(pending)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  shop      Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum Role {
  CUSTOMER
  SHOPKEEPER
}

enum ShopStatus {
  open
  closed
  maintenance
  inactive
}

enum OrderStatus {
  pending
  confirmed
  processing
  ready
  completed
  cancelled
  refunded
}

enum OrderType {
  NOW
  SCHEDULED
}

enum PaymentMethod {
  CARD
  WALLET
  CASH
  UPI
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum ReviewStatus {
  pending
  approved
  rejected
}

enum NotificationType {
  ORDER_PLACED
  ORDER_CONFIRMED
  ORDER_PREPARING
  ORDER_READY
  ORDER_COMPLETED
  ORDER_CANCELLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
}
